# -*- mode: ruby -*-
# vi: set ft=ruby :
# D:\VirtualBox => Các cấu hình được lưu trữ tại đây


Vagrant.configure("2") do |config|
  # Base box Ubuntu 22.04 LTS
  config.vm.box = "ubuntu/jammy64"
  
  # Cấu hình chung cho tất cả máy ảo
  config.vm.boot_timeout = 600  # Tăng timeout lên 10 phút
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
    # Tối ưu VirtualBox
    vb.customize ["modifyvm", :id, "--vram", "16"]
    vb.customize ["modifyvm", :id, "--accelerate3d", "off"]
  end

  # Định nghĩa 3 máy ảo K8s
  machines = [
    { name: "redis-server-1", ip: "192.168.1.180", memory: 2048, cpus: 2, disk: 20 },
    { name: "redis-server-2", ip: "192.168.1.181", memory: 2048, cpus: 2, disk: 20 },
    { name: "redis-server-3", ip: "192.168.1.182", memory: 2048, cpus: 2, disk: 20 },
  ]

  machines.each do |machine|
    config.vm.define machine[:name] do |node|
      # Hostname
      node.vm.hostname = machine[:name]
      
      # Network - Bridge mode với IP tĩnh
      node.vm.network "public_network", 
        ip: machine[:ip],
        netmask: "255.255.255.0",
        bridge: "Realtek 8852CE WiFi 6E PCI-E NIC"
      
      # Provider-specific settings
      node.vm.provider "virtualbox" do |vb|
        vb.name = machine[:name]
        vb.memory = machine[:memory]
        vb.cpus = machine[:cpus]
        
        # Tối ưu cho K8s
        vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
        vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
        
      end

      # Provisioning script chung
      node.vm.provision "shell", inline: <<-SHELL
        # Update system
        apt-get update
        apt-get upgrade -y
        
        # Cấu hình hosts file
        cat >> /etc/hosts << 'EOF'
127.0.0.1 localhost
192.168.1.180 redis-server-1
192.168.1.181 redis-server-2
192.168.1.182 redis-server-3
EOF

        # Cấu hình netplan cho IP tĩnh
        cat > /etc/netplan/50-vagrant.yaml << 'EOF'
network:
  version: 2
  ethernets:
    enp0s8:
      dhcp4: false
      addresses:
        - #{machine[:ip]}/24
      gateway4: 192.168.1.1
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4
EOF

        netplan apply
        apt update -y
        apt upgrade -y

        apt install -y net-tools telnet traceroute

        # -----> Cài đặt Redis <-----
        sudo apt install -y lsb-release curl gpg
        curl -fsSL https://packages.redis.io/gpg | sudo gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/redis.list
        sudo apt update -y
        sudo apt install -y redis redis-sentinel
        sudo systemctl enable redis-server
        sudo systemctl start redis-server
        sudo systemctl status redis-server


        # -----> Thực hiện trên server 1 <-----
        # sudo vi /etc/redis/redis.conf
        # bind 0.0.0.0 # Searh bind
        # masterauth bodevops # Searh masterauth
        # requirepass bodevops

        # Những cấu hình cần thiết khác(optional)
        # protected-mode no # Tắt protected mode
        # appendonly yes # Enable AOF
        # appendfilename "appendonly.aof"
        # appendfsync everysec # Sync AOF every second
        # no-appendfsync-on-rewrite yes
        # auto-aof-rewrite-percentage 100 # Auto rewrite AOF percentage
        # auto-aof-rewrite-min-size 64mb
        # aof-load-truncated yes # Load truncated AOF
        # aof-use-rdb-preamble yes
        # aof-rewrite-incremental-fsync yes # Incremental fsync AOF
        # aof-rewrite-incremental-fsync-delay 50ms
        # aof-rewrite-incremental-fsync-delay-min 50ms # Incremental fsync AOF delay min
        # aof-rewrite-incremental-fsync-delay-max 50ms
        # maxmemory 100mb # Set max memory
        # maxmemory-policy allkeys-lru # Set max memory policy
        # maxmemory-samples 3 # Set max memory samples
        # maxmemory-policy allkeys-lru # Set max memory policy

        # sudo systemctl restart redis-server
        # sudo systemctl enable redis-server
        # sudo systemctl status redis-server

        # -----> Thực hiện trên server 2 và server 3 <-----
        # vi /etc/redis/redis.conf
        # bind 0.0.0.0
        # masterauth bodevops
        # requirepass bodevops
        # replicaof 192.168.1.180 6379
        
        # sudo systemctl restart redis-server
        # sudo systemctl enable redis-server
        # sudo systemctl status redis-server

        # Thực hiện trên server 1
        # redis-cli

        # Kiểm tra HA 
        # auth bodevops
        # SET test "123123"
        # GET test (Thực hiện cả 3 server)

        # Thực hiện trên cả 3 servers
        # Cấu hình sentinel
        # sudo vi /etc/redis/sentinel.conf

        # protected-mode no
        # sentinel monitor master 192.168.1.180 6379 2 # Cần 2 server để quyết định master
        # sentinel auth-pass master bodevops
        # sentinel down-after-milliseconds master 5000
        # sentinel failover-timeout master 60000
        # sentinel parallel-syncs master 1

        # sudo systemctl restart redis-sentinel
          

        # redis-cli -p 26379 sentinel masters
        # redis-cli -p 26379 sentinel slaves master
        # redis-cli -p 26379 sentinel sentinels master
        # sudo systemctl stop redis-server # => Test switch master

      SHELL
    end
  end
end